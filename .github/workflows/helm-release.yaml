name: Package Helm Charts

on:
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  release-charts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.12.0

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Update chart versions
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          for CHART in component-chart loki-stack; do
            CHART_PATH="helm/${CHART}/Chart.yaml"
            if [ ! -f "$CHART_PATH" ]; then
              echo "::error::Missing $CHART_PATH"
              exit 1
            fi
            sed -i "s/^version:.*/version: ${VERSION}/" "$CHART_PATH"
            echo "Updated $CHART_PATH to ${VERSION}"
          done

      - name: Add chart repositories
        run: |
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Update chart dependencies
        run: |
          set -euo pipefail
          for CHART in component-chart loki-stack; do
            CHART_DIR="helm/${CHART}"
            if [ -f "$CHART_DIR/Chart.yaml" ] && grep -q "dependencies:" "$CHART_DIR/Chart.yaml"; then
              echo "Updating dependencies for ${CHART}"
              helm dependency update "$CHART_DIR"
            else
              echo "No dependencies to update for ${CHART}"
            fi
          done

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure gh-pages branch exists
        run: |
          set -euo pipefail
          if git ls-remote --exit-code origin gh-pages >/dev/null 2>&1; then
            echo "gh-pages branch already exists"
          else
            echo "Creating gh-pages branch"
            PREV_REF=$(git rev-parse HEAD)
            git checkout --orphan gh-pages
            git reset --hard
            touch .nojekyll
            git add .nojekyll
            git commit -m "Initialize gh-pages branch"
            git push origin gh-pages
            git checkout "$PREV_REF"
          fi

      - name: Release charts
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          charts_dir: helm
          pages_branch: gh-pages
          skip_existing: true
